import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Sparkles, PartyPopper, Heart, CalendarDays, Image as ImageIcon, Music2, Gift } from "lucide-react";

// ===== Quick personalisation =====
const NAME = "Your Sister"; // 👈 change this
const TAGLINE = "Happy Birthday! 🎉 Here's a little walk down memory lane.";

// Placeholder timeline data (swap images & copy later)
const TIMELINE = [
  {
    date: "2010",
    title: "The Cheeky Grin Era",
    text:
      "Back when your smile could convince anyone to share their snacks.",
    image:
      "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop"
  },
  {
    date: "2015",
    title: "Tiny Wins, Big Dreams",
    text:
      "You turned every little victory into a festival. We learned from you.",
    image:
      "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop"
  },
  {
    date: "2018",
    title: "Explorer Mode Unlocked",
    text:
      "New cities, new foods, new playlists. The world started keeping up with you.",
    image:
      "https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop"
  },
  {
    date: "2021",
    title: "Making Magic",
    text:
      "You turned ideas into projects and projects into memories.",
    image:
      "https://images.unsplash.com/photo-1514250605469-45fda3b5d3c9?q=80&w=1200&auto=format&fit=crop"
  },
  {
    date: "2024",
    title: "The Glow Up",
    text:
      "Growth, grit, and grace. We saw you becoming unstoppable.",
    image:
      "https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?q=80&w=1200&auto=format&fit=crop"
  },
  {
    date: "2025",
    title: "Today",
    text:
      "Another year of you. Can’t wait for what’s next. 💜",
    image:
      "https://images.unsplash.com/photo-1517817748496-62f19938c23d?q=80&w=1200&auto=format&fit=crop"
  }
];

// ===== confetti canvas (lightweight) =====
const Confetti: React.FC = () => {
  const ref = useRef<HTMLCanvasElement | null>(null);
  useEffect(() => {
    const c = ref.current;
    if (!c) return;
    const ctx = c.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    let w = (c.width = window.innerWidth * dpr);
    let h = (c.height = 260 * dpr);
    const N = 120;
    const pieces = Array.from({ length: N }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      r: 2 + Math.random() * 4,
      vx: -0.5 + Math.random(),
      vy: 0.5 + Math.random() * 1.5,
      a: Math.random() * Math.PI
    }));
    let raf: number;

    const draw = () => {
      if (!ctx) return;
      ctx.clearRect(0, 0, w, h);
      for (const p of pieces) {
        p.x += p.vx;
        p.y += p.vy;
        p.a += 0.03;
        if (p.y > h) p.y = -10;
        if (p.x > w) p.x = -10;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.globalAlpha = 0.85;
        ctx.fillRect(-p.r, -p.r, p.r * 2, p.r * 2);
        ctx.restore();
      }
      raf = requestAnimationFrame(draw);
    };
    draw();
    const onResize = () => {
      w = c.width = window.innerWidth * dpr;
      h = c.height = 260 * dpr;
    };
    window.addEventListener("resize", onResize);
    return () => {
      cancelAnimationFrame(raf);
      window.removeEventListener("resize", onResize);
    };
  }, []);
  return <canvas ref={ref} className="absolute inset-0 h-[260px] w-full opacity-70" />;
};

// ===== Hook: which card is active while scrolling =====
function useActiveIndex(count: number) {
  const [active, setActive] = useState(0);
  const refs = useMemo(() => Array.from({ length: count }, () => React.createRef<HTMLDivElement>()), [count]);
  useEffect(() => {
    const io = new IntersectionObserver(
      (entries) => {
        entries.forEach((e) => {
          const idx = Number((e.target as HTMLDivElement).dataset.index);
          if (e.isIntersecting) setActive(idx);
        });
      },
      { rootMargin: "-30% 0px -60% 0px", threshold: 0.0 }
    );
    refs.forEach((r) => r.current && io.observe(r.current));
    return () => io.disconnect();
  }, [refs]);
  return { active, refs } as const;
}

// ===== Main component =====
export default function BirthdayTimeline() {
  const { active, refs } = useActiveIndex(TIMELINE.length);
  return (
    <div className="min-h-screen bg-gradient-to-b from-pink-50 via-white to-violet-50 text-zinc-900 dark:from-zinc-950 dark:via-zinc-900 dark:to-zinc-950 dark:text-zinc-100">
      {/* HERO */}
      <section className="relative overflow-hidden border-b border-zinc-200/60 dark:border-zinc-800/60">
        <Confetti />
        <div className="relative z-10 mx-auto max-w-6xl px-4 py-16 sm:py-20">
          <motion.h1
            initial={{ opacity: 0, y: 16 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            className="text-4xl sm:text-6xl font-extrabold tracking-tight"
          >
            {NAME}'s Birthday
          </motion.h1>
          <motion.p
            initial={{ opacity: 0, y: 16 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1, duration: 0.6 }}
            className="mt-3 text-lg sm:text-xl max-w-2xl text-zinc-700 dark:text-zinc-300"
          >
            {TAGLINE}
          </motion.p>
          <div className="mt-6 flex flex-wrap items-center gap-3">
            <a href="#timeline" className="inline-flex items-center rounded-full border px-4 py-2 text-sm hover:bg-white/60 dark:hover:bg-white/10">
              <CalendarDays className="mr-2 h-4 w-4" /> Explore Timeline
            </a>
            <span className="inline-flex select-none items-center rounded-full bg-pink-500/10 px-3 py-1 text-sm">
              <PartyPopper className="mr-2 h-4 w-4" /> Scroll for surprises
            </span>
          </div>
        </div>
      </section>

      {/* SCROLLY TIMELINE */}
      <section id="timeline" className="relative mx-auto max-w-6xl px-4">
        <div className="grid grid-cols-1 lg:grid-cols-[420px,1fr] gap-10 py-16">
          {/* Sticky side narrative */}
          <aside className="lg:sticky lg:top-6 h-max">
            <motion.div
              key={active}
              initial={{ opacity: 0, y: 6 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.3 }}
              className="rounded-3xl border border-zinc-200/70 bg-white/70 p-6 shadow-sm backdrop-blur dark:border-zinc-800 dark:bg-zinc-900/60"
            >
              <div className="mb-2 text-xs uppercase tracking-wide text-pink-600 dark:text-pink-400">Chapter {active + 1} of {TIMELINE.length}</div>
              <h3 className="text-2xl font-semibold">{TIMELINE[active].title}</h3>
              <p className="mt-2 text-zinc-700 dark:text-zinc-300">{TIMELINE[active].text}</p>
              <div className="mt-4 inline-flex items-center rounded-full bg-zinc-100 px-3 py-1 text-xs text-zinc-600 dark:bg-zinc-800 dark:text-zinc-300">
                <Gift className="mr-2 h-3.5 w-3.5" /> {TIMELINE[active].date}
              </div>
            </motion.div>
            <div className="mt-4 text-sm text-zinc-500 dark:text-zinc-400">
              As you scroll, the story on the left changes. Swap the images & text later to make it personal. 💫
            </div>
          </aside>

          {/* Right: animated cards */}
          <div className="relative">
            <div className="absolute left-4 top-0 bottom-0 hidden w-px bg-gradient-to-b from-pink-300 via-violet-300 to-cyan-300 lg:block" />
            <ul className="space-y-10">
              {TIMELINE.map((item, i) => (
                <li key={i}>
                  <div
                    ref={refs[i]}
                    data-index={i}
                    className="grid grid-cols-1 items-center gap-4 lg:grid-cols-[56px,1fr]"
                  >
                    {/* Dot */}
                    <div className="hidden lg:flex items-center justify-center">
                      <motion.div
                        initial={{ scale: 0.6, opacity: 0 }}
                        whileInView={{ scale: 1, opacity: 1 }}
                        viewport={{ once: true, margin: "-100px" }}
                        className={`h-4 w-4 rounded-full ${i === active ? "bg-pink-500" : "bg-zinc-300 dark:bg-zinc-600"}`}
                      />
                    </div>

                    {/* Card */}
                    <motion.div
                      initial={{ opacity: 0, y: 24 }}
                      whileInView={{ opacity: 1, y: 0 }}
                      viewport={{ once: true, margin: "-100px" }}
                      transition={{ duration: 0.45 }}
                      className="overflow-hidden rounded-3xl border border-zinc-200/70 bg-white/80 shadow-sm backdrop-blur dark:border-zinc-800 dark:bg-zinc-900/60"
                    >
                      <div className="relative">
                        <img
                          src={item.image}
                          alt={item.title}
                          className="h-64 w-full object-cover"
                          loading="lazy"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/35 to-transparent" />
                        <div className="absolute left-4 top-4 inline-flex items-center rounded-full bg-white/80 px-3 py-1 text-xs shadow-sm backdrop-blur dark:bg-black/40">
                          <CalendarDays className="mr-2 h-3.5 w-3.5" /> {item.date}
                        </div>
                      </div>
                      <div className="p-5">
                        <h4 className="text-lg font-semibold">{item.title}</h4>
                        <p className="mt-1 text-sm text-zinc-600 dark:text-zinc-300">{item.text}</p>
                      </div>
                    </motion.div>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      {/* GALLERY (placeholders) */}
      <section className="mx-auto max-w-6xl px-4 pb-20">
        <div className="mb-6 flex items-center justify-between">
          <h2 className="text-2xl font-semibold flex items-center gap-2"><ImageIcon className="h-5 w-5"/> Memories Gallery</h2>
          <span className="text-sm text-zinc-500">Tap a photo to send hearts</span>
        </div>
        <div className="columns-1 gap-4 sm:columns-2 lg:columns-3 [column-fill:_balance]"><Gallery /></div>
      </section>

      {/* FOOTER */}
      <footer className="border-t border-zinc-200/60 py-10 text-center text-sm text-zinc-500 dark:border-zinc-800/60">
        Built with ❤️ for {NAME}. Swap the placeholders and deploy.
      </footer>
    </div>
  );
}

function Gallery() {
  const imgs = [
    "https://images.unsplash.com/photo-1512428559087-560fa5ceab42?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1510771463146-e89e6e86560e?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1478144592103-25e218a04891?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1487412947147-5cebf100ffc2?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1499363536502-87642509e31b?q=80&w=1200&auto=format&fit=crop",
  ];
  return (
    <div>
      {imgs.map((src, i) => (
        <Likeable key={i} src={src} />
      ))}
    </div>
  );
}

function Likeable({ src }: { src: string }) {
  const [liked, setLiked] = useState(false);
  return (
    <div className="relative mb-4 overflow-hidden rounded-3xl">
      <img src={src} className="w-full object-cover" alt="memory"/>
      <button
        onClick={() => setLiked((s) => !s)}
        className={`absolute right-3 top-3 rounded-full p-2 backdrop-blur transition ${
          liked ? "bg-pink-600 text-white" : "bg-white/80 text-zinc-700 dark:bg-black/40 dark:text-zinc-200"
        }`}
        aria-label="like"
      >
        <Heart className={`h-4 w-4 ${liked ? "fill-white" : ""}`} />
      </button>
    </div>
  );
}
